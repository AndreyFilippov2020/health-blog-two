
services:
    nginx:
        image: 'nginx:latest'
        volumes:
            - './:/var/www'
            - './_docker/nginx/conf.d:/etc/nginx/conf.d'
        ports:
            - '80:80'
            - '443:443'
        depends_on:
            - app
        container_name: project_nginx

    app:
        build:
            context: .
            dockerfile: _docker/app/Dockerfile
        volumes:
            - ./:/var/www
        ports:
            - '5173:5173' # Для HTTP-запросов Vite
            - '5174:5174' # Для WebSocket-соединений Vite
        environment:
            TZ: 'Europe/Moscow'
        depends_on:
            - db
            - redis
        container_name: project_app
        command: >
            sh -c "
            supervisord -c /etc/supervisor/supervisord.conf &&
            php-fpm"

    db:
        image: 'mysql/mysql-server:8.0'
        restart: always
        volumes:
            - ./tmp/db:/var/lib/mysql
        environment:
            MYSQL_ROOT_PASSWORD: '${DB_PASSWORD}'
            MYSQL_ROOT_HOST: '%'
            MYSQL_DATABASE: '${DB_DATABASE}'
            MYSQL_USER: '${DB_USERNAME}'
            MYSQL_PASSWORD: '${DB_PASSWORD}'
            MYSQL_ALLOW_EMPTY_PASSWORD: 1
        ports:
            - '8101:3306'
        command: mysqld --character-set-server=utf8 --collation-server=utf8_unicode_ci
        container_name: project_db

    redis:
        image: redis:alpine
        ports:
            - '6379:6379'
        container_name: project_redis

    mailpit:
        image: axllent/mailpit:latest
        ports:
            - '8025:8025' # Веб-интерфейс Mailpit
            - '1025:1025' # SMTP сервер
        container_name: project_mailpit

    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        platform: linux/amd64
        environment:
            PMA_HOST: db
            MYSQL_ROOT_PASSWORD: '${DB_PASSWORD}'
        ports:
            - '127.0.0.1:8080:80'
        depends_on:
            - db
        container_name: project_phpmyadmin
